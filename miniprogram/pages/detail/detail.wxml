<!--pages/detail/detail.wxml-->
<wxs src="../../WXS/subutil_title.wxs" module="title_tools" />
<wxs module="indexofStr">
  module.exports.includes = function (str, str_) {
    return str.indexOf(str_);
  }
</wxs>
<wxs module = "getDate" src="../../WXS/sub_date.wxs"></wxs>
<wxs src="../../WXS/cal_view.wxs" module="random" />

<!-- 合并为一个容器，通过条件类控制树洞背景 -->
<view class="container {{ (task[0].radioGroup == 'radio40' || task[0].radioGroup == 'radio41' || task[0].radioGroup == 'radio42' || task[0].radioGroup == 'radio43') ? 'treehole-style' : '' }}">

  <!-- 详情 -->
  <view class="detail" style="width: 100%;">
    <block wx:for="{{ task }}" wx:key="index" wx:for-item="task">
      <view class="task-list-title">
        <!-- <image wx:if="{{ is_self }}" class="up_img" src='../../images/up.png' bindtap='updatetime' mode='aspectFill'></image> -->     
        <text class="task_title" wx:if="{{task.radioGroup == 'radio4'}}">树洞 | 吐槽</text>
        <text class="task_title" wx:elif="{{task.radioGroup == 'radio40'}}">树洞 | 吐槽</text>
        <text class="task_title" wx:elif="{{task.radioGroup == 'radio41'}}">树洞 | 倾诉</text>
        <text class="task_title" wx:elif="{{task.radioGroup == 'radio42'}}">树洞 | 心愿</text>
        <text class="task_title" wx:elif="{{task.radioGroup == 'radio43'}}">树洞 | 知乎</text>
        <text class="task_title" wx:elif="{{task.radioGroup == 'radio6'}}">告白</text>
        <text class="task_title" wx:elif="{{task.radioGroup == 'radio1'}}">租房信息</text>
        <text user-select class="task_title" wx:else>{{task.title}}</text>
      </view>

      <view class="task-list-time">
        <!-- 热度展示（原判断完整保留，仅保留一份） -->
        <view class="hot-box">
            <text class="watch-text">{{random.random(task.watchNum,UV,task.c_time)}}人围观</text>
        </view>

        <view class="time-box">
          <text class="task_title">{{ getDate.getGap(task.c_time) }}</text>
        </view>
        <view wx:if="{{task.campusGroup == '1'}}" class="campus-box" data-id="{{ task.id }}">良乡校区</view>
        <view wx:elif="{{task.campusGroup == '0'}}" class="campus-box" data-id="{{ task.id }}">中关村校区</view>
        <view wx:else class="campus-box" data-id="{{ task.id }}"></view> 
        <view class="delete-box"> 
          <text wx:if="{{ is_self || isdel}}" bindtap='delete_detail' class="delete-button" data-id="{{ task.id }}">删除</text>
        </view>
      </view>

      <view class="task-list-content">
        <view class="task_content">
          <text user-select class="text-content">{{ task.content }}</text>
        </view>
        <view class='task-list-img' wx:if="{{ img != '' }}">
          <image class="image" wx:for-items="{{ img }}" src="{{ item + '?imageView2/2/w/700'}}" mode="widthFix" data-src="{{item}}" bindtap="imgYu"></image>
        </view>

        <view class="like" bindtap='thumbsup' wx:if="{{ hasUserInfo }}">
          <view wx:if="{{ state }}">
            <text wx:if="{{ task.price!= '' }}" class="task_price">￥{{ task.price }}</text>
            <image class="like_img" src='../../images/love2.png' mode='aspectFill'></image>
            <text class="like_title">已喜欢</text>
          </view>
          <view wx:else>
            <text wx:if="{{ task.price!= '' }}" class="task_price">￥{{ task.price }}</text>
            <image class="like_img" src='../../images/love.png' mode='aspectFill'></image>
            <text class="like_title">喜欢</text>
          </view>
        </view>

        <view class="like" bindtap='nologin' wx:else>
          <view wx:if="{{ state }}">
            <text wx:if="{{ task.price!= '' }}" class="task_price">¥{{ task.price }}</text>
            <image class="like_img" src='../../images/love2.png' mode='aspectFill'></image>
            <text class="like_title">已喜欢</text>
          </view>
          <view wx:else>
            <text wx:if="{{ task.price!= '' }}" class="task_price">¥{{ task.price }}</text>
            <image class="like_img" src='../../images/love.png' mode='aspectFill'></image>
            <text class="like_title">喜欢</text>
          </view>
        </view>
      </view>

      <view class="botton-list">
        <button class="wx-button-1" bindtap='get_info' wx:if="{{ task.wechat}}"> 联系对方 </button>
        <button class="wx-button-1" bindtap='return_index' wx:if="{{ !(task[0].radioGroup == 'radio40' || task[0].radioGroup == 'radio41' || task[0].radioGroup == 'radio42' || task[0].radioGroup == 'radio43') }}"> 返回主页 </button>
        <button class="wx-button-1" bindtap='toTreeHole' wx:else> 返回树洞 </button>
        <button class="wx-button-1" bindtap='toSuggestion'> 举报 </button>
      </view>
    </block>
  </view>

  <!-- 评论区：只保留一份，通过类名切换树洞 / 普通配色与卡片背景 -->
  <view class="comment_zone" style="{{ (task[0].radioGroup == 'radio40' || task[0].radioGroup == 'radio41' || task[0].radioGroup == 'radio42' || task[0].radioGroup == 'radio43') ? 'width: 100%; min-height: 900rpx;' : 'width: 100%;' }}">
    <view style="width:100%" wx:if="{{ list.length > 0 }}">
      <view class="scrollView-small">
        <view class="menu-list-small" wx:for="{{sub_menu.descs}}" wx:key="index">
          <view class="menu-item-small" data-id="{{ sub_menu.name[index] }}" bindtap='bottomNavChange'  data-current="{{index}}">
            <view class="menu-desc-small {{currentSmallTab==index ? 'on-small' : ''}}" data-id="{{ sub_menu.name[index] }}">{{sub_menu.descs[index]}}</view>
          </view>
        </view>
      </view>  
    </view>

    <view class="pro-con">
      <block wx:for="{{ list }}" wx:key="index">
        <view class="inline-block">
          <view class="avatar-box">
            <image class="img" src="{{ item.avatar }}" mode="aspectFit"></image>
          </view>

          <!-- 核心：只保留一个 pro-box，树洞用 4 色背景，普通用 normal-color -->
          <view class="pro-box {{ (task[0].radioGroup == 'radio40' || task[0].radioGroup == 'radio41' || task[0].radioGroup == 'radio42' || task[0].radioGroup == 'radio43') ? (item.id % 4 == 1 ? 'bg-1' : (item.id % 4 == 0 ? 'bg-0' : (item.id % 4 == 3 ? 'bg-3' : 'bg-else'))) : 'normal-color' }}">
            <view class="head">
              <view class="box">
                <view class="shead_clear">
                  <view class="names_fl">{{item.userName}}</view>
                </view>
              </view>
              <view class="delete-comment-box"> 
                <text wx:if="{{current_openid == item.openid || isdel}}" bindtap='delete_comment' class="delete-comment" data-id="{{ item.id }}">删除</text>
              </view>
            </view>

            <view class="addr-info">
              <view class="addr-text {{ (task[0].radioGroup == 'radio40' || task[0].radioGroup == 'radio41' || task[0].radioGroup == 'radio42' || task[0].radioGroup == 'radio43') ? '' : 'black-text' }}">
                <text user-select>{{item.comment}}</text>
                <image class="image-comment" wx:if="{{item.img}}" src="{{ item.img + '?imageView2/2/w/200'}}" mode="widthFix" data-src="{{item.img}}" bindtap="commentYu"></image>
              </view>
            </view>

            <view class="info">
              <view class="text">
                <text decode="true">{{getDate.getGap(item.c_time)}}</text>
              </view>
              <view class="reply {{ (task[0].radioGroup == 'radio40' || task[0].radioGroup == 'radio41' || task[0].radioGroup == 'radio42' || task[0].radioGroup == 'radio43') ? '' : 'reply-normal' }}"
                    bindtap="reply"
                    data-id="{{item.openid}}"
                    data-user="{{item.userName}}"
                    data-pid="{{ item.id }}"
                    data-second="{{index}}">回复</view>
              <view>
                <image src="../../images/click_on.png" class="click-img" bindtap="unClickComment" data-id="{{item.id}}" wx:if="{{indexofStr.includes(clickList,item.id)>-1}}"></image>
                <image src="../../images/click.png" class="click-img" bindtap="clickComment" data-id="{{item.id}}" wx:else></image>
                <text class="click-text" wx:if="{{item.like_num == 0}}"> 赞</text>
                <text class="click-text" wx:else> {{item.like_num}}</text>
              </view>
            </view>

            <!-- 二级评论：同一套结构，颜色/背景已由父容器决定 -->
            <view wx:for="{{item.commentList}}" wx:for-index="childindex" wx:for-item="secondLevel" class="second-level">
              <view class="head">
                <view class="box">
                  <view class="shead_clear" style="margin-top: 20rpx;">
                    <view class="avatar-box-small"><image class="img" src="{{ secondLevel.avatar }}" mode="aspectFit"></image></view>
                    <view class="names_fl">{{secondLevel.userName}}</view>
                    <text wx:if="{{current_openid == secondLevel.openid || isdel}}" bindtap='delete_comment' class="delete-comment" data-id="{{ secondLevel.id }}" style="margin-left: 20rpx;">删除</text>
                  </view>
                  <view class="addr-info">
                    <view class="addr-text {{ (task[0].radioGroup == 'radio40' || task[0].radioGroup == 'radio41' || task[0].radioGroup == 'radio42' || task[0].radioGroup == 'radio43') ? '' : 'black-text' }}">
                      <text user-select>{{secondLevel.comment}}</text>
                      <image class="image-comment" wx:if="{{secondLevel.img}}" src="{{ secondLevel.img + '?imageView2/2/w/200'}}" mode="widthFix" data-src="{{secondLevel.img}}" bindtap="commentYu"></image>
                    </view>
                  </view>
                  <view class="info">
                    <view class="text">
                      <text decode="true">{{getDate.getGap(secondLevel.c_time)}}</text>
                    </view>
                    <view class="reply {{ (task[0].radioGroup == 'radio40' || task[0].radioGroup == 'radio41' || task[0].radioGroup == 'radio42' || task[0].radioGroup == 'radio43') ? '' : 'reply-normal' }}"
                          bindtap="reply"
                          data-id="{{secondLevel.openid}}"
                          data-user="{{secondLevel.userName}}"
                          data-pid="{{item.id}}"
                          data-second="{{index}}">回复</view>
                    <view>
                      <image src="../../images/click_on.png" class="click-img" bindtap="unClickComment" data-id="{{secondLevel.id}}" wx:if="{{indexofStr.includes(clickList,secondLevel.id)>-1}}"></image>
                      <image src="../../images/click.png" class="click-img" bindtap="clickComment" data-id="{{secondLevel.id}}" wx:else></image>
                      <text class="click-text" wx:if="{{secondLevel.like_num == 0}}"> 赞</text>
                      <text class="click-text" wx:else> {{secondLevel.like_num}}</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>

          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- 发布区：保留一份，原逻辑/入参/事件不变 -->
  <form bindsubmit="submitForm" report-submit="true">
    <view class="release">
      <view wx:if="{{task[0].radioGroup == 'radio4' || task[0].radioGroup == 'radio40' || task[0].radioGroup == 'radio41' || task[0].radioGroup == 'radio42' || task[0].radioGroup == 'radio43'}}" class="nickNameinfo">  
        <input class="name__bar" wx:if="{{ !is_self }}" placeholder-class="input_null" value="{{nickNameOld}}" name="nickNameinfo" placeholder="请输入昵称" minlength="0" maxlength="50" />
      </view>

      <view wx:if="{{reply}}" class="replyinfo">
        <textarea placeholder-class="input_null" fixed="true" maxlength="-1" show-confirm-bar="false" cursor-spacing="15" auto-height="true" placeholder="请输入回复" name="comment" value='回复{{replyName}}:{{form_info}}'></textarea>
        <image src="../../images/pic.png" bindtap="takePhoto" mode="aspectFit" wx:if="{{imgOriList.length == 0}}"></image> 
        <image src="{{imgOriList[0] + '?imageView2/2/w/50'}}" bindtap="takePhoto" mode="aspectFit" wx:else></image>  
        <button form-type="submit" class="submit" wx:if="{{ hasUserInfo }}">发送</button>
        <button bindtap="nologin" class="submit" wx:else>发送</button>
      </view>

      <view class="replyinfo" wx:else>
        <textarea placeholder-class="input_null" fixed="true" maxlength="-1" show-confirm-bar="false" cursor-spacing="15" auto-height="true" placeholder="请输入回复" name="comment" value='{{form_info}}'></textarea>
        <image src="../../images/pic.png" bindtap="takePhoto" mode="aspectFit" wx:if="{{imgOriList.length == 0}}"></image>
        <image src="{{imgOriList[0] + '?imageView2/2/w/50'}}" bindtap="takePhoto" mode="aspectFit" wx:else></image>      
        <button form-type="submit" class="submit" wx:if="{{ hasUserInfo }}">发送</button>
        <button bindtap="nologin" class="submit" wx:else>发送</button>
      </view>
    </view>
  </form>

</view>
